# GitHub Actions Workflow: Automated Fraud Detection Deployment
# Purpose: Pulls the latest Docker image and runs fraud detection predictions on a remote server
name: Run Fraud Detection on Server

# Trigger Configuration
on:
  push:
    branches:
      - main # Automatically run when code is pushed to main branch
  workflow_dispatch: # Enable manual execution via GitHub Actions UI

# Global Variables
env:
  DOCKER_IMAGE: sampurnr/fraud-detector # Docker Hub repository name

jobs:
  run-predictions:
    runs-on: ubuntu-latest # GitHub-hosted Ubuntu runner

    steps:
      # ========================================
      # Step 1: SSH into server and execute predictions
      # ========================================
      - name: Run predictions on server via SSH
        uses: appleboy/ssh-action@v1.0.3 # Third-party action for SSH connections
        with:
          # Connection credentials (stored securely in GitHub Secrets)
          host: ${{ secrets.SERVER_IP }} # Server IP address
          username: ${{ secrets.SERVER_USERNAME }} # SSH username
          password: ${{ secrets.SERVER_PASSWORD }} # SSH password
          port: ${{ secrets.SERVER_PORT || 22 }} # SSH port (default: 22)

          # Commands executed on remote server
          script: |
            # Pull latest multi-platform image from Docker Hub
            # Note: sudo required if user lacks Docker group permissions
            sudo docker pull ${{ env.DOCKER_IMAGE }}:latest

            # Train the model first (if not already trained)
            # This creates the best model in /data/models/
            sudo docker run --rm -v /data/creditcard.csv:/app/creditcard.csv:ro -v /data/models:/app/models ${{ env.DOCKER_IMAGE }}:latest python train_best_model.py

            # Execute fraud detection predictions
            # - Runs once and removes itself after completion (--rm flag)
            # - Mounts data and models as read-only volumes for security
            # - Analyzes 20 sample transactions and displays results
            sudo docker run --rm -v /data/creditcard.csv:/app/creditcard.csv:ro -v /data/models:/app/models:ro ${{ env.DOCKER_IMAGE }}:latest python predict.py --model-path models/best_fraud_detector.pkl --mode sample --samples 20

      # ========================================
      # Step 2: Report deployment status
      # ========================================
      - name: Prediction status
        if: success() # Only executes if all previous steps completed successfully
        run: |
          echo "âœ… Predictions completed!"
          echo "Image: ${{ env.DOCKER_IMAGE }}:latest"
          echo "Server: ${{ secrets.SERVER_IP }}"
