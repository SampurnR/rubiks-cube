# GitHub Actions Workflow: Automated Fraud Detection Deployment
# Purpose: Pulls the latest Docker image and runs fraud detection predictions on a remote server
name: Run Fraud Detection on Server

# Trigger Configuration: When this workflow will run
on:
  push:
    branches:
      - main # Automatically run when code is pushed to main branch
  workflow_dispatch: # Enable manual execution via GitHub Actions UI

# Global Variables: Environment variables available to all jobs
env:
  DOCKER_IMAGE: sampurnr/fraud-detector # Docker Hub repository name

# Jobs: Define the tasks to execute
jobs:
  run-predictions:
    runs-on: ubuntu-latest # GitHub-hosted Ubuntu runner

    steps:
      # ========================================
      # Step 1: SSH into server and execute commands
      # ========================================
      - name: Deploy and run fraud detection
        uses: appleboy/ssh-action@v1.0.3 # Third-party action for SSH connections
        with:
          # Connection credentials (stored securely in GitHub Secrets)
          host: ${{ secrets.SERVER_IP }} # Server IP address
          username: ${{ secrets.SERVER_USERNAME }} # SSH username
          password: ${{ secrets.SERVER_PASSWORD }} # SSH password
          port: ${{ secrets.SERVER_PORT || 22 }} # SSH port (default: 22)

          # Commands executed on remote server
          script: |
            # Pull latest Docker image from Docker Hub
            # Note: sudo required if user lacks Docker group permissions
            sudo docker pull ${{ env.DOCKER_IMAGE }}:latest

            # Train the fraud detection model
            # - Creates the best model in /data/models/
            # - Uses credit card data from /data/creditcard.csv
            # - Mounts /data directory for read/write access
            # - Container is automatically removed after completion (--rm flag)
            sudo docker run --rm -v /data:/data ${{ env.DOCKER_IMAGE }}:latest python train_best_model.py

            # Run predictions on sample transactions
            # - Runs once and removes itself after completion (--rm flag)
            # - Mounts /data directory as read-only for security (:ro flag)
            # - Analyzes 20 random sample transactions
            # - Displays fraud probabilities and transaction details
            sudo docker run --rm -v /data:/data:ro ${{ env.DOCKER_IMAGE }}:latest python predict.py --mode sample --samples 20
